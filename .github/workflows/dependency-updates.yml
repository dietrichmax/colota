name: Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  update-dependencies:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install npm-check-updates
        run: npm install -g npm-check-updates

      - name: Check for updates
        run: |
          ncu > updates.txt
          cat updates.txt

      - name: Create issue if updates available
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const updates = fs.readFileSync('updates.txt', 'utf8');
            
            if (updates.includes('â†’')) {
              const issueBody = `## ðŸ“¦ Dependency Updates Available
              
              The following packages have updates available:
              
              \`\`\`
              ${updates}
              \`\`\`
              
              ### How to update:
              
              \`\`\`bash
              # Update all packages
              ncu -u
              npm install
              
              # Or update specific packages
              npm update package-name
              \`\`\`
              
              **Note**: Test thoroughly after updating, especially major version changes.
              
              ---
              *Automatically generated by dependency-update workflow*`;
              
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'dependencies'
              });
              
              const existingIssue = issues.data.find(issue => 
                issue.title === 'ðŸ“¦ Dependency Updates Available'
              );
              
              if (existingIssue) {
                // Update existing issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: issueBody
                });
                console.log('Updated existing issue');
              } else {
                // Create new issue
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ðŸ“¦ Dependency Updates Available',
                  body: issueBody,
                  labels: ['dependencies', 'maintenance']
                });
                console.log('Created new issue');
              }
            } else {
              console.log('No updates available');
            }

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: audit
        run: npm audit --audit-level=moderate --json > audit.json
        continue-on-error: true

      - name: Create security issue if vulnerabilities found
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let auditData;
            
            try {
              auditData = JSON.parse(fs.readFileSync('audit.json', 'utf8'));
            } catch (e) {
              console.log('No audit data found');
              return;
            }
            
            if (auditData.metadata && auditData.metadata.vulnerabilities) {
              const vulns = auditData.metadata.vulnerabilities;
              const total = vulns.moderate + vulns.high + vulns.critical;
              
              if (total > 0) {
                const issueBody = `## ðŸš¨ Security Vulnerabilities Detected
                
                **Severity Breakdown:**
                - Critical: ${vulns.critical}
                - High: ${vulns.high}
                - Moderate: ${vulns.moderate}
                
                ### Action Required:
                
                \`\`\`bash
                # Review vulnerabilities
                npm audit
                
                # Fix automatically (if possible)
                npm audit fix
                
                # Force fix (use with caution)
                npm audit fix --force
                \`\`\`
                
                **âš ï¸ Important**: Review changes carefully before committing, especially with \`--force\` flag.
                
                ---
                *Automatically generated by security-audit workflow*`;
                
                const issues = await github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  labels: 'security'
                });
                
                const existingIssue = issues.data.find(issue => 
                  issue.title.includes('Security Vulnerabilities Detected')
                );
                
                if (!existingIssue) {
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: `ðŸš¨ Security Vulnerabilities Detected (${total} found)`,
                    body: issueBody,
                    labels: ['security', 'critical']
                  });
                  console.log('Created security issue');
                }
              }
            }